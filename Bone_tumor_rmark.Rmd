---
title: "Bone_tumor_data_analysis"
author: "MF"
date: "2023-09-23"
output: html_document
---
This notebook analyses a dataset on patients from the Memorial Sloan Kettering Cancer Center (MSKCC). 

This data was collected from Kaggle, URL: https://www.kaggle.com/datasets/antimoni/bone-tumor 

Objectives: 

  1. explore the dataset (descriptive statistics, visualisation, relationships between vars)
  
  2. modify the dataset for modelling 
  
  3. model whether patients survived their bout with bone cancer 
  

Note: I am NOT a medical expert, any and all input into interpreting the results are appreciated and this notebook should not be used as evidence of anything pertaining to bone cancer.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

1.) Setup and data description


The following packages are used to analyse the dataset.

```{r Packages used, results='hide'}
packages_used <- c('dplyr', 'ggplot2', 'caTools', 'randomForest', 'sjmisc', 'tidyr', 'sjPlot')
lapply(packages_used, library, character.only = T)
```


The dataset contains 500 observations with 9 variables, the first being a unique ID for patients (unsure why but in the original data this was not unique. The uploader has 'fixed' this, but no current indication what caused this). There are no missing values and most of the variables are character variables containing qualitative information about the patient, their condition and the treatment they received.  


The code below displays the dataset and the basic features of each variable, showing the data types for each variable, checks for missing values, the number of unique values in qualitative variables and the frequency of each qualitative variable.

```{r my data, include=FALSE}
rm(list = ls())
dataset <- read.csv('C:\\Users\\Matthew\\OneDrive\\Documents\\Bone_Tumor.csv')
```

```{r Dataset basic information}
head(dataset) 
tail(dataset) 
sapply(dataset, function(x) typeof(x)) #prints type of data 
sapply(dataset, function(x) sum(is.na(x))) #na numbers
sapply(dataset, function(x) length(unique(x))) #unique values
sapply(dataset, function(x) frq(x)) #prints count
```


Excluding the patient ID, the remaining 8 variables of interest are: 

1.) status (DV): Alive with disease (awd) 112, dead (D) 141, no evidence of disease (NED) 247. 50% elimination rate for treatment 

2.) treatment (IV): split between Surgery + radiotherapy, surgery + radiotherapy + chemotherapy and surgery + chemotherapy. 

3.) site: Right and left thigh account for 57% of sites, buttock is about 21% of sites, rest of the sites are in the shoulders or left arm.

4.) type: Leiomyosarcoma, smooth muscle tumor, most commonly in abdomen; Malignant fibrous histiocytoma (MFH), very rarely in the bones, mostly in muscles and tendons; Synovial sarcoma, can negatively affect joint movement, seemingly very rare cancer.

5.) grade: high or intermediate - high = 218, inter = 282  

6.) histological_type: Contains 13 total variations in type. Would need medical expertise to correctly differentiate the types though, they seem similar in some instances.

7.) sex: male - 200, female - 300 

8.) age: Only numeric variable in the dataset. The following code shows the distribution and descriptive statistics for the age variable, showing that the age of patients varies significantly. There are two peaks in mid-40s and in mid-60s. Most patients are old, reflected in the mean and median being essentially the same at 55-56. The variation is shown in the large standard deviation of 16. 

```{r Age distribution}
hist(dataset$age)
mean(dataset$age)   
median(dataset$age) 
sd(dataset$age)     
```


There are significant problems with this dataset that limit its use for serious analysis. 


Firstly, there is no timetable to understand how and when treatment was applied. This means there is no information on what stage the cancer was in before and during treatment, making it very difficult to understand why certain treatments were selected. This undermines our understanding of how treatment affects patient status: was radiotherapy + chemotherapy + surgery only used in extreme cases, or based on age/gender or cancer placement. This is unclear without more explanation of the dataset. 


Secondly, the dataset is very small to understand the relationship between treatment and outcome. This exacerbates the first problem; with no indication on why or how long treatments were used, this dataset may produced very skewed results for modelling. The cancer site variable highlights this issue - there are significantly more tumors afflicting patients lower bodies and all upper arm tumors were located on patients left sides. Patterns like this do not matter is significantly larger datasets, but artifacts may skew results in this small dataset. 


Thirdly, the distinction between different histological types of tumors should only be interpreted by an expert. Quick research into medicinal journals and websites is very unlikely to be enough to actually interpret how the type of tumor affects treatment, the cancer site and status of the patient. This makes one very important variable unintelligible without extensive knowledge of the subject matter. 


However, this is not a serious analysis of bone cancer and all the results should be interpreted with these factors in mind.



2.) Relationships between dependent and independent variables  


This section assesses the relationship between patient status (dependent variable), different treatments (independent variable). 

Since the variables are primarily qualitative factor variables, crosstabulation is the preferred method to assess the relationship between the columns. While this will not show statistically significant relationships, this will show the direction of the relationship generally.

```{r DV IV Crosstabulation} 
tab_xtab(dataset$status, dataset$treatment, title = 'Status of patient by treatment', show.col.prc = T)

#ODDS for different treatments and deaths 

((215+18)/60)  #rad+sur: AWD + NED /D
((89 + 24)/30) #rad+sur+chem: AWD + NED/D
(51/(13))      #chem+sur: D/AWD+NED

```
The crosstab reports statistically significant effects from the different treatments. Radiotherapy + surgery appears to be effective, with 73% of patients showing no evidence of remaining cancer, 20% of patients died and 6% were alive with disease. Radiotherapy + surgery + chemotherapy appears less effective, with only 16% of patients having no evidence of cancer, 21% of patients dying and 62% alive with the disease. Finally, chemotherapy + surgery is generally unsuccessful, with 80% of the column dying, 7.8% alive with the disease and only 12% of patients having no evidence of cancer. 


Therefore, radiotherapy and surgery used together reported the highest chance of survival, with the odds of no evidence of the disease being significantly greater than he other two treatments. However, the other two treatments are significantly more extreme procedures for patients and it is possible that this factor is the underlying cause for the different effects of treatments. Notably, radiotherapy + surgery + chemotherapy used together reported very high chance of survival (odds of AWD or NED over death is 3.7) and so the treatment is still very effective, perhaps just used in very extreme cases which makes it difficult to completely eliminate the cancer. Patients who received surgery and chemotherapy together have a much higher odds of of dying than surviving (odds of death are 3.9 over surviving). Consequently, would expect that treatment significantly affects patients status, with radiotherapy and surgery having a positive effect on survival.     


However, since it is suspected that the treatment is affected by the grade of the cancer, it is important to check the crosstabulation for these two variables. The code below creates the crosstab to test whether this is true. The crosstabulation confirms the suspicions that the grade of cancer is related to the prescribed treatment. The odds of a patient receiving radiotherapy + surgery instead of radiotherapy + surgery + chemotherapy for high grade cancer is .48, suggesting that the success rate of radiotherapy + surgery is affected by the propensity for this treatment to be used on intermediate grade cancers. Surgery + chemotherapy, however, still seems fairly ineffective because there is no evidence that this treatment is used more on high grade tumors. Perhaps radiotherapy is itself a statistically significant factor. Again, however, the small sample size means that generalisable conclusions are not appropriate.

```{r crosstab for IV and grade of cancer}
tab_xtab(dataset$treatment, dataset$grade, title = 'Treatment recieved by grade of cancer', show.col.prc = T)

#Odds ratios for types of treatment by grade
(77/(116 +25)) / (116/(77+25))      #receiving Rad + Sur vs Rad sur + chemo  for high grade 

```


3.) Control variables


This section will briefly overview the relationship between patient status and: 

  1. sex 
  
  2. age 
  
  3. grade 
  
  4. mskcc_type 

```{r remaking age var for analyses}
#remaking age variable for crosstabulation
age <- dataset$age
dataset$age_cat <- dplyr::case_when(
  age >= 17 & age <= 25 ~ '17_25',
  age > 25 & age <= 35 ~ '26_35', 
  age > 35 & age <= 45 ~ '36_45', 
  age > 45 & age <= 55 ~ '46_55', 
  age > 55 & age <= 65 ~ '56_65', 
  age > 65 & age <= 75 ~ '66_75', 
  age > 75 ~ '75+'
)
```


```{r control variables and patient status}

tab_xtab(dataset$status, dataset$sex, title = 'Patient status by sex', show.col.prc = T)

tab_xtab(dataset$status, dataset$grade, title = 'Patient status by grade of cancer', show.col.prc = T)

tab_xtab(dataset$status, dataset$mskcc_type, title = 'Patient status by type of cancer', show.col.prc = T)

tab_xtab(dataset$status, dataset$age_cat, title = 'Patient status by age category', show.col.prc = T) 
ano<-aov(age ~ status, data = dataset) #anova test
summary(ano)
```

Sex appears to have a relationship with status. However, there is very little difference in the survival rate, the difference is between patients who are alive with cancer and those with no evidence of remaining cancer. Women are much more likely to show no evidence of cancer (208 women to 39 men), while men were more likely to be alive with disease (98 men to 14 women). Death, however, appears to be distributed relatively evenly between the sexes. 


Cancer grade also appears to have a relationship with patient status. Intermediate grade cancer is much more likely to be eliminated by treatment, 178 patients with intermediate grade cancer showed no evidence of disease while only 69 patients with high grade cancers showed no evidence of disease. As a result, the grade of the cancer must be taken into account when analysing patient status. 


The type of cancer - broken into leiomyosarcoma, malignant fibrous histiocytoma (MFH) and snynovial sarcoma - appears to have a relationship with patient status. Patients with leiomyosarcomas were much more likely to have no evidence of cancer post-treatment, whereas patients with MFH were more likely to be alive with the disease. Patients with snynovial sarcoma's were more likely to die than the other two types. Therefore, the type of cancer tumor must be controlled for.


Age is analysed as a numeric variable and categorically - first with a crosstabulation and second with a one-way anova test. The anova reports a statistically different mean between patient status, suggesting that age and patient status are related. The exact relationship is difficult to narrow down considering the age range is very high, but it is notable that the relative percentages of survival increases through the age ranges and percentages of patients who died decreases as the patient gets older. However, there are so few patients between 17-35 that these relationships may be based on outliers. 



4.) Data transformations


The qualitative variables are transformed into dummy variables. The code below shows each transformation. Because we use random forest classification and a logistic regression and compare the results, the dependent variable is made twice: 1 is a dummy variable for the logistic regression and the other is a factor variable for classification.

```{r making categorical variables, echo=TRUE}
#Dependent variable 
#survived 
dataset$survived <- dplyr::case_when(
  dataset$status == 'NED' | dataset$status == 'AWD' ~ 'survived',
  dataset$status == 'D' ~ 'died'
)
dataset$survived <- as.factor(dataset$survived)

dataset$survived_dummy <- dplyr::case_when(
  dataset$status == 'NED' | dataset$status == 'AWD' ~ 1,
  dataset$status == 'D' ~ 0
)

#Independent variable = treatment 
dataset$rad_sur <- dplyr::case_when(
  dataset$treatment == 'Radiotherapy + Surgery' ~ 1, 
  dataset$treatment == 'Radiotherapy + Surgery + Chemotherapy' | dataset$treatment == 'Surgery + Chemotherapy' ~ 0
)

dataset$rad_sur_chem <- dplyr::case_when(
  dataset$treatment == 'Radiotherapy + Surgery + Chemotherapy' ~ 1, 
  dataset$treatment == 'Radiotherapy + Surgery' | dataset$treatment == 'Surgery + Chemotherapy' ~ 0
)

dataset$sur_chem <- dplyr::case_when(
  dataset$treatment == 'Surgery + Chemotherapy' ~ 1, 
  dataset$treatment == 'Radiotherapy + Surgery + Chemotherapy' | dataset$treatment == 'Radiotherapy + Surgery' ~ 0
)

#control variables

dataset$male <- dplyr::case_when(
  dataset$sex == 'Male' ~ 1, 
  dataset$sex == 'Female' ~ 0
)

dataset$pensioner <- dplyr::case_when(
  dataset$age >= 65 ~ 1, 
  dataset$age < 65 ~ 0
)

dataset$high_risk <- dplyr::case_when(
  dataset$grade == 'High' ~ 1, 
  dataset$grade == 'Intermediate' ~ 0
)

dataset$leiomyosarcoma <- dplyr::case_when( 
  dataset$mskcc_type == 'Leiomyosarcoma' ~ 1, 
  dataset$mskcc_type == 'MFH' | dataset$mskcc_type == 'Synovial sarcoma' ~ 0
)

dataset$synsarcoma <- dplyr::case_when( 
  dataset$mskcc_type == 'Synovial sarcoma' ~ 1, 
  dataset$mskcc_type == 'Leiomyosarcoma' | dataset$mskcc_type == 'MFH' ~ 0
)

```


To complete the modelling, the datasets are split into two for simplicity - one to do the logistic and the second for the random forest. The set.seed function ensures that the dataset is split identically, this just makes it easier to use all the possible variables in the random forest but make a specific formula for th logistic regression. The dataset for logistic regression is saved as dataset_log and the dataset for the random forest is saved as dataset_forest.  


The rationale for splitting the datasets is to let R optimise the forest while only selecting hyperparameters, whereas with the logistic regression it will be important to select base categories for the dummy variables. The code then creates the split ratio and train/test splits for the datasets using caTools. 


```{r preprocessing for the models}
#making separate dataset objects
dataset_log <- subset(dataset, select = -c(ID))
dataset_forest <- subset(dataset, select = -c(ID, survived_dummy, age_cat, male, pensioner, 
                                              leiomyosarcoma, high_risk, status, synsarcoma, 
                                              rad_sur, rad_sur_chem, sur_chem))
#makes results reproducible 
set.seed(666)
split_ratio <- sample.split(dataset, SplitRatio = .75)

#log data
train_log <- subset(dataset_log, split_ratio == T)  
test_log <- subset(dataset_log, split_ratio == F)

#forest data
train_forest<- subset(dataset_forest, split_ratio == T)
test_forest <- subset(dataset_forest, split_ratio == F)
```


5.) Modelling 


The code below runs the random forest model and the logistic regression model. 


The random forest model is a classification model constructed of 500 trees. The model reports and accuracy score of 73% on the test data and the OOB error rate is predicted to be 20%, which seems consistent. The important factors according to the variable importance plot are treatment, cancer tumor type and grade of cancer. The other factors are notably less important. However, age is important for decreasing gini impurities in the trees, even if it is not considered an 'important variable'.  

 
```{r Random Forest modelling}
set.seed(666)
forest_mod<- randomForest(survived ~ .,
                          data = train_forest, 
                          importance = T, proximity = T, replace = T)


forest_mod              #OOB 20% error rate
varImpPlot(forest_mod)  #plot of variable importance

#predictions 
pred_forest_y <- predict(forest_mod, test_forest, type = 'response')
table(test_forest$survived, pred_forest_y)  #confusion matrix of results
mean(pred_forest_y == test_forest$survived) 
```


The model is less accurate at predicting deaths, but is fairly accurate at predicting survival. Running the model with more data points for patients who died might increase the accuracy the model. As a result, the treatment the patient receives significantly affects the survival rate of the patient, but predicting death is very difficult.

The below code creates and runs the logistic regression model and makes predictions using the formula.

The logistic regression model requires more explanation. The model uses dummy variables and tests the relationship between the dummies and survival. The variables in the model have clear base categories: 

  
  treatment: The rad_sur and rad_sur_chem variables are showing the effects of these treatments against 'chemo_sur' (base category). 
  
  
  high_risk: The base case (score of 0) is intermediate grade and the estimate is the effect of high grade cancer tumors on survival. 
  
  
  male: The variable ranges from 0 (female) to 1 (male), which demonstrates the difference between the sexes and survival.  
  
  
  synsarcoma & leiomyosarcoma: base case is MFH, which was the most frequent type in the dataset. The effect of the different types is interpreted against MFH. 
  
  
  age: this is a numeric variable, so the coefficient is interpreted as the effect of a 1 unit increase in age on the log odds of survival.
  
```{r logistic regression}
set.seed(666)
log_model <- glm(survived_dummy ~ rad_sur + rad_sur_chem + high_risk + male + synsarcoma + leiomyosarcoma + 
                   age, data = dataset_log, family = binomial())

summary(log_model) 
exp(log_model$coefficients)

#predictions
pred_log_y <- predict(log_model, test_log, type = 'response')  
pred_log_y <- round(pred_log_y, digits = 0)
table(test_log$survived_dummy, pred_log_y)
mean(pred_log_y == test_log$survived_dummy) 
```

To help explain how this affects interpreting the model, the intercept is showing the log odds of survival if the variables are 0, which would be a female who received chemotherapy+surgery for an intermediate MFH tumor who is 0 years old. While not perfect, this model should help understand how treatment affects survival and the effects of the controls.  


The model suggests that treatment has a significant effect on the log odds of survival. Radiotherapy + surgery and radiotherapy + surgery + chemotherapy had significant positive effects on the log odds of survival. The exponential of the coefficients show the average change in odds of survival based on these treatments are very high; 9.15 for rad_sur and 13.6 for rad_sur_chem. This model shows that age and whether the cancer is a leiomyosarcoma also have significant positive effects on the log odds of survival. 


The logistic regression model is very accurate in predicting the survival of patients in the test data, with 76% accuracy score and the confusion matrix showing that it more accurately predicts status than the random forest. However, the model still struggles to predict deaths, highlighting that using treatment as the major variable is not necessarily an accurate predictor for patient survival in this dataset. 

